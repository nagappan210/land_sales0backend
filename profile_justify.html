<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Account Justification</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const justifyData = JSON.parse(sessionStorage.getItem("profile_justify"));
      if (!justifyData || justifyData.result !== "1") {
        document.getElementById("content").innerHTML = "<p class='text-center text-gray-500'>No justification required.</p>";
        return;
      }

      const user = justifyData.data.user_details;
      const reports = justifyData.data.reports;

      document.getElementById("username").innerText = user.username;
      document.getElementById("fullname_display").innerText = user.name;
      document.getElementById("fullname_input").value = user.name;
      document.getElementById("email_input").value = user.email;

      const imageUrl = user.profile_image || localStorage.getItem("profile_image");
      document.getElementById("profile_image").innerHTML = `
        <img src="${imageUrl || "https://via.placeholder.com/80?text=User"}"
            alt="Profile"
            class="w-16 h-16 rounded-full border border-gray-300 shadow-md object-cover">
      `;

      const reportsList = document.getElementById("reports-list");
      reports.forEach(r => {
        const li = document.createElement("li");
        li.className = "flex items-center gap-2 text-sm text-red-700 bg-red-50 px-3 py-2 rounded-lg mb-2";
        li.innerHTML = `<span class="font-medium">${r.report_sentence}</span>`;
        reportsList.appendChild(li);
      });

      const hiddenUserId = document.createElement("input");
      hiddenUserId.type = "hidden";
      hiddenUserId.name = "user_id";
      hiddenUserId.value = user.user_id;
      document.getElementById("appealForm").appendChild(hiddenUserId);

      const fileInput = document.getElementById("evidence");
      const fileList = document.getElementById("file-list");
      const uploadBtn = document.getElementById("uploadBtn");
      const textarea = document.querySelector("textarea[name='reason_appeal']");

      uploadBtn.addEventListener("click", () => fileInput.click());
      fileInput.addEventListener("change", () => {
        fileList.innerHTML = "";
        Array.from(fileInput.files).forEach((file, idx) => {
          const li = document.createElement("li");
          li.className = "flex items-center justify-between bg-gray-100 px-3 py-2 rounded-lg mb-2 text-sm";
          li.innerHTML = `
            <span>${file.name} <span class="text-gray-500 text-xs">(${(file.size/1024/1024).toFixed(1)} MB)</span></span>
            <button type="button" data-idx="${idx}" class="text-red-500 hover:text-red-700 font-bold">âœ•</button>
          `;
          fileList.appendChild(li);
        });

        fileList.querySelectorAll("button").forEach(btn => {
          btn.addEventListener("click", () => {
            const dt = new DataTransfer();
            Array.from(fileInput.files).forEach((f, i) => {
              if (i != btn.dataset.idx) dt.items.add(f);
            });
            fileInput.files = dt.files;
            btn.parentElement.remove();
          });
        });
      });


      const counter = document.createElement("p");
      counter.className = "text-xs text-gray-500 mt-1";
      textarea.parentNode.appendChild(counter);
      const updateCounter = () => {
        counter.innerText = `${textarea.value.length} / 200 characters`;
      };
      textarea.addEventListener("input", updateCounter);
      updateCounter();

      document.getElementById("appealForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const form = e.target;
  const formData = new FormData(form);

  try {
    const res = await fetch("http://localhost:7000/admin/submit_justify", {
      method: "POST",
      body: formData
    });
    const json = await res.json();

    if (json.result === "1") {
      // Set success message text
      document.getElementById("successMessage").innerText = 
        `Your appeal has been received. Our team will review it and update you at the email address you provided (${formData.get("email")})`;

      // Show modal
      const modal = document.getElementById("successModal");
      modal.classList.remove("hidden");
      modal.classList.add("flex");

      // Reset form and file list
      form.reset();
      document.getElementById("file-list").innerHTML = "";
    } else {
      alert(json.error || "Failed to submit appeal");
    }

  } catch (err) {
    alert("Error: " + err.message);
  }

  return false;
});

// Close modal button
document.getElementById("closeModal").addEventListener("click", () => {
  const modal = document.getElementById("successModal");
  modal.classList.add("hidden");
  modal.classList.remove("flex");
});

    });
  </script>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-6">
  <div class="bg-white shadow-lg rounded-xl p-6 w-full max-w-lg border border-gray-200" id="content">

    <h2 class="text-xl font-bold text-gray-900 text-left">Your Account has been Restricted</h2>
    <p class="text-gray-600 mt-2 text-left">
      Your account has been restricted due to multiple reports. If you believe this was a mistake, please explain below. Our team will review your appeal and notify you once a decision is made.
    </p>

    <div class="flex items-center gap-4 mt-6 bg-gray-50 p-4 rounded-lg">
      <div id="profile_image"></div>
      <div class="flex-1">
        <p class="font-semibold text-gray-800 text-lg" id="username"></p>
        <p class="text-sm text-gray-500" id="fullname_display"></p>
      </div>
    </div>

    <div class="mt-6">
      <p class="font-medium text-gray-800 mb-2">Reported for:</p>
      <ul id="reports-list"></ul>
    </div>

    <form id="appealForm" enctype="multipart/form-data" class="mt-6 space-y-5">
      <div>
        <label class="block text-sm font-medium text-gray-700">Name*</label>
        <input type="text" id="fullname_input" name="name" required
          class="w-full border rounded-lg p-2 mt-1 focus:ring focus:ring-blue-200" />
      </div>

      <div>
        <label class="block text-xs font-medium text-gray-600">Email Address*</label>
        <input type="email" id="email_input" name="email" required
          class="w-full border rounded-lg p-2 mt-1 focus:ring focus:ring-blue-200 text-sm" />
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700">Reason for the Appeal*</label>
        <textarea name="reason_appeal" rows="4" required
            placeholder="Start typing here..."
            class="w-full border rounded-lg p-2 mt-1 focus:ring focus:ring-blue-200"></textarea>
      </div>

      <div class="space-y-4 mt-6">
        <div class="bg-gray-50 p-4 rounded-lg border">
          <label class="block text-sm font-semibold text-gray-800">Supporting Evidence</label>
          <p class="text-xs text-gray-500 mb-2">Upload PNG, JPEG, or PDF (Max 10 MB)</p>

          <button type="button" id="uploadBtn"
            class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700">
            ðŸ“¤ Click to upload
          </button>
          <input type="file" id="evidence" name="supporting_evidence" multiple accept=".png,.jpg,.jpeg,.pdf" class="hidden" />

          <ul id="file-list" class="mt-3"></ul>
        </div>

        <div class="flex items-start gap-2">
          <input type="checkbox" id="appeal_confirm" required
            class="mt-1 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring focus:ring-blue-200" />
          <label for="appeal_confirm" class="text-sm text-gray-700 leading-tight">
            I understand that false or repeated appeals may lead to further restrictions.
          </label>
        </div>

        <!-- Success Modal -->
<div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-xl shadow-lg max-w-sm w-full p-6 text-center relative">
    <div class="mb-4">
      <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
      </svg>
    </div>
    <h3 class="text-lg font-semibold mb-2">Appeal Submitted</h3>
    <p class="text-gray-600 mb-4" id="successMessage">Your appeal has been received.</p>
    <button id="closeModal" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Okay</button>
  </div>
</div>

    </form>

    <button onclick="history.back()" 
      class="mt-4 w-full text-gray-600 hover:text-gray-900 text-sm font-medium">&larr; Back</button>
  </div>
</body>
</html>
